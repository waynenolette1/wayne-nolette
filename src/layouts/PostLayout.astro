---
import ArticleLayout from './ArticleLayout.astro';
import type { CollectionEntry } from 'astro:content';
import { formatDate } from '../utils/date';
import { calculateReadingTime } from '../utils/reading-time';
import { generateBreadcrumbSchema } from '../utils/seo';

/**
 * Props for the PostLayout component.
 * Uses ArticleLayout for shared structure with writing-specific slots.
 */
interface Props {
  /** The writing collection entry containing post data and content */
  post: CollectionEntry<'writing'>;
  /** Related posts based on shared tags or project */
  relatedPosts?: CollectionEntry<'writing'>[];
  /** Linked case study if this post references one via project field */
  linkedCaseStudy?: CollectionEntry<'case-studies'>;
}

const { post, relatedPosts = [], linkedCaseStudy } = Astro.props;
const {
  title,
  description,
  pubDate,
  updatedDate,
  tags,
  confidenceLevel,
  depth,
} = post.data;

// Map depth to display label and icon
const depthLabels: Record<string, { label: string; description: string }> = {
  overview: {
    label: 'Overview',
    description: 'High-level concepts and introduction',
  },
  'deep-dive': {
    label: 'Deep Dive',
    description: 'Detailed technical analysis',
  },
  implementation: {
    label: 'Implementation',
    description: 'Code-level details and patterns',
  },
};

const formattedDate = formatDate(pubDate);
const readingTime = calculateReadingTime(post.body || '');

// Generate breadcrumb schema for SEO
const breadcrumbSchema = generateBreadcrumbSchema(
  [
    { name: 'Home', url: import.meta.env.BASE_URL },
    { name: 'Writing', url: `${import.meta.env.BASE_URL}writing/` },
    { name: title, url: `${import.meta.env.BASE_URL}writing/${post.id}/` },
  ],
  Astro.site?.toString() || ''
);

const footerLinks = [
  {
    url: `${import.meta.env.BASE_URL}writing/`,
    text: 'Back to Writing',
    direction: 'left' as const,
  },
  {
    url: `${import.meta.env.BASE_URL}case-studies/`,
    text: 'View Case Studies',
    direction: 'right' as const,
  },
];
---

<ArticleLayout
  title={title}
  description={description}
  backUrl={`${import.meta.env.BASE_URL}writing/`}
  backText="All Writing"
  ctaText="Questions or thoughts on this article?"
  footerLinks={footerLinks}
  publishedTime={pubDate.toISOString()}
  breadcrumbSchema={breadcrumbSchema}
  headerClass="post-header"
  contentClass="post-content"
  contentId="post-content"
>
  <!-- Article Summary Box -->
  <Fragment slot="header-extra">
    <div class="info-box">
      <div class="info-box-label">Article Info</div>
      <div class="info-box-meta">
        <span
          ><strong>Published:</strong>
          <time datetime={pubDate.toISOString()}>{formattedDate}</time></span
        >
        <span><strong>Reading time:</strong> {readingTime} min</span>
        {
          updatedDate && (
            <span>
              <strong>Updated:</strong> {formatDate(updatedDate)}
            </span>
          )
        }
        {
          confidenceLevel && (
            <span>
              <strong>Confidence:</strong>{' '}
              <span class={`confidence confidence-${confidenceLevel}`}>
                {confidenceLevel === 'high' ? 'High' : 'Medium'}
              </span>
            </span>
          )
        }
        {
          depth && (
            <span title={depthLabels[depth]?.description}>
              <strong>Depth:</strong>{' '}
              <span class={`depth-indicator depth-${depth}`}>
                {depthLabels[depth]?.label}
              </span>
            </span>
          )
        }
      </div>
    </div>

    {
      tags && tags.length > 0 && (
        <div class="labeled-tags">
          <span class="labeled-tags-label">Tags:</span>
          <div class="labeled-tags-list">
            {tags.map((tag) => (
              <span class="labeled-tag-subtle">{tag}</span>
            ))}
          </div>
        </div>
      )
    }

    {
      linkedCaseStudy && (
        <a
          href={`${import.meta.env.BASE_URL}case-studies/${linkedCaseStudy.id}/`}
          class="case-study-link"
        >
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            aria-hidden="true"
          >
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
          </svg>
          Part of case study: {linkedCaseStudy.data.title}
        </a>
      )
    }
  </Fragment>

  <!-- Share section in footer -->
  <Fragment slot="footer-extra">
    <div class="share-section">
      <span class="share-label">Share this article</span>
      <div class="share-buttons">
        <button
          class="share-btn"
          id="native-share-btn"
          aria-label="Share article"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            aria-hidden="true"
          >
            <circle cx="18" cy="5" r="3"></circle>
            <circle cx="6" cy="12" r="3"></circle>
            <circle cx="18" cy="19" r="3"></circle>
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
          </svg>
          Share
        </button>
        <button
          class="share-btn copy-link-btn"
          id="copy-link-btn"
          aria-label="Copy link"
        >
          <svg
            class="link-icon"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            aria-hidden="true"
          >
            <path
              d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"
            ></path>
            <path
              d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"
            ></path>
          </svg>
          <svg
            class="check-icon"
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            aria-hidden="true"
            style="display: none;"
          >
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span class="btn-text">Copy link</span>
        </button>
      </div>
    </div>
  </Fragment>

  <!-- Related posts -->
  <Fragment slot="related">
    {
      relatedPosts && relatedPosts.length > 0 && (
        <section class="related-articles">
          <h2>Related Articles</h2>
          <div class="related-grid">
            {relatedPosts.map((related) => (
              <a
                href={`${import.meta.env.BASE_URL}writing/${related.id}/`}
                class="related-card"
              >
                <span class="related-title">{related.data.title}</span>
                <span class="related-description">
                  {related.data.description}
                </span>
                {related.data.tags && related.data.tags.length > 0 && (
                  <div class="related-tags">
                    {related.data.tags.slice(0, 3).map((tag) => (
                      <span class="related-tag">{tag}</span>
                    ))}
                  </div>
                )}
              </a>
            ))}
          </div>
        </section>
      )
    }
  </Fragment>

  <!-- Main content -->
  <slot />
</ArticleLayout>

<style>
  /* ===== Confidence Badge (inline in info-box-meta) ===== */
  .confidence {
    padding: var(--spacing-2xs) var(--spacing-sm);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
  }

  .confidence-high {
    background: linear-gradient(
      135deg,
      var(--color-success-15) 0%,
      var(--color-success-05) 100%
    );
    color: var(--color-success);
    border: 1px solid var(--color-success-30);
  }

  .confidence-medium {
    background: linear-gradient(
      135deg,
      var(--color-warning-15) 0%,
      var(--color-warning-05) 100%
    );
    color: var(--color-warning);
    border: 1px solid var(--color-warning-30);
  }

  /* ===== Depth Indicator (inline in info-box-meta) ===== */
  .depth-indicator {
    padding: var(--spacing-2xs) var(--spacing-sm);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
    cursor: help;
  }

  .depth-overview {
    background: linear-gradient(
      135deg,
      var(--color-accent-15) 0%,
      var(--color-accent-5) 100%
    );
    color: var(--color-accent);
    border: 1px solid var(--color-accent-30);
  }

  .depth-deep-dive {
    background: linear-gradient(
      135deg,
      var(--color-gradient-purple-15) 0%,
      var(--color-gradient-purple-5) 100%
    );
    color: var(--color-gradient-purple);
    border: 1px solid var(--color-gradient-purple-30);
  }

  .depth-implementation {
    background: linear-gradient(
      135deg,
      var(--color-gradient-pink-15) 0%,
      var(--color-gradient-pink-05) 100%
    );
    color: var(--color-gradient-pink);
    border: 1px solid var(--color-gradient-pink-30);
  }

  /* ===== Case Study Link ===== */
  .case-study-link {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-accent-08);
    border: 1px solid var(--color-accent-20);
    border-radius: var(--radius-md);
    color: var(--color-accent);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    text-decoration: none;
    transition: all var(--transition-fast);
    margin-top: var(--spacing-sm);
  }

  @media (hover: hover) {
    .case-study-link:hover {
      background: var(--color-accent-15);
      border-color: var(--color-accent-35);
      transform: translateY(var(--lift-sm));
    }
  }

  /* ===== Share Section ===== */
  .share-section {
    margin-bottom: var(--spacing-xl);
    padding: var(--spacing-lg);
    background: var(--color-bg-subtle);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--color-accent);
    border-radius: var(--radius-lg);
  }

  .share-label {
    display: block;
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-subtle);
    margin-bottom: var(--spacing-md);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-widest);
  }

  .share-buttons {
    display: flex;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
  }

  .share-btn {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-muted);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    letter-spacing: var(--letter-spacing-subtle);
    cursor: pointer;
    transition: all var(--transition-bounce);
    overflow: hidden;
  }

  .share-btn svg {
    flex-shrink: 0;
    transition: transform var(--transition-bounce);
  }

  @media (hover: hover) {
    .share-btn:hover {
      border-color: var(--color-link);
      color: var(--color-link);
      background: var(--color-bg-elevated);
      transform: translateY(var(--lift-sm));
      box-shadow: var(--shadow-md);
    }

    .share-btn:hover svg {
      transform: scale(1.1);
    }
  }

  .share-btn:focus-visible {
    outline: none;
    color: var(--color-link);
    box-shadow:
      inset 0 0 0 2px var(--color-accent-40),
      0 0 0 3px var(--color-bg),
      0 0 0 5px var(--color-accent-30);
  }

  .share-btn.copied {
    background: linear-gradient(
      135deg,
      var(--color-success-15) 0%,
      var(--color-success-05) 100%
    );
    border-color: var(--color-success-30);
    color: var(--color-success);
  }
</style>

<script is:inline>
  // Share button functionality (post-specific)
  (function () {
    // Guard to prevent listener stacking on View Transitions
    if (window.__postLayoutRegistered) return;
    window.__postLayoutRegistered = true;

    // Store handler references for proper cleanup

    var pendingTimeouts = [];

    function handleShare(e) {
      var btn = e.target.closest('#native-share-btn');
      if (!btn) return;
      if (!navigator.share) return;

      var desc = document.querySelector('meta[name="description"]');
      navigator
        .share({
          title: document.title,
          text: desc ? desc.getAttribute('content') || '' : '',
          url: window.location.href,
        })
        .catch(function () {
          // AbortError is expected when user cancels share dialog
        });
    }

    function handleCopyLink(e) {
      var btn = e.target.closest('#copy-link-btn');
      if (!btn) return;

      navigator.clipboard
        .writeText(window.location.href)
        .then(function () {
          var linkIcon = btn.querySelector('.link-icon');
          var checkIcon = btn.querySelector('.check-icon');
          var btnText = btn.querySelector('.btn-text');

          if (linkIcon && checkIcon && btnText) {
            linkIcon.style.display = 'none';
            checkIcon.style.display = 'block';
            btnText.textContent = 'Copied!';
            btn.classList.add('copied');

            var timeoutId = setTimeout(function () {
              linkIcon.style.display = 'block';
              checkIcon.style.display = 'none';
              btnText.textContent = 'Copy link';
              btn.classList.remove('copied');
            }, 1000);
            pendingTimeouts.push(timeoutId);
          }
        })
        .catch(function () {
          // Clipboard may be blocked - show error feedback
          var btnText = btn.querySelector('.btn-text');
          if (btnText) btnText.textContent = 'Failed';
          var timeoutId = setTimeout(function () {
            if (btnText) btnText.textContent = 'Copy link';
          }, 1000);
          pendingTimeouts.push(timeoutId);
        });
    }

    function initShareButtons() {
      var nativeShareBtn = document.getElementById('native-share-btn');
      if (nativeShareBtn && !navigator.share) {
        nativeShareBtn.style.display = 'none';
      }
    }

    function cleanup() {
      document.removeEventListener('click', handleShare);
      document.removeEventListener('click', handleCopyLink);
      // Clear any pending timeouts
      pendingTimeouts.forEach(function (id) {
        clearTimeout(id);
      });
      pendingTimeouts = [];
    }

    function setupListeners() {
      // Clean up first to prevent duplicates
      cleanup();

      // Use event delegation on document for share buttons (works after View Transitions)
      document.addEventListener('click', handleShare);
      document.addEventListener('click', handleCopyLink);
    }

    function init() {
      initShareButtons();
      setupListeners();
    }

    init();

    // Cleanup before view transition swap
    document.addEventListener('astro:before-swap', cleanup);

    // Re-init after view transitions
    document.addEventListener('astro:after-swap', init);
  })();
</script>
