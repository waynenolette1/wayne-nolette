---
import ArticleLayout from './ArticleLayout.astro';
import type { CollectionEntry } from 'astro:content';
import { generateBreadcrumbSchema } from '../utils/seo';

/**
 * Props for the CaseStudyLayout component.
 * Uses ArticleLayout for shared structure with case-study-specific slots.
 */
interface Props {
  /** The case-studies collection entry containing study data and content */
  study: CollectionEntry<'case-studies'>;
  /** Related case studies based on shared tech or themes */
  relatedStudies?: CollectionEntry<'case-studies'>[];
  /** Related writing articles that reference this case study */
  relatedPosts?: CollectionEntry<'writing'>[];
}

const { study, relatedStudies = [], relatedPosts = [] } = Astro.props;
const {
  title,
  description,
  role,
  duration,
  outcome,
  tech,
  skills,
  metrics,
  ownership,
} = study.data;

// Map skill slugs to display names
const skillLabels: Record<string, string> = {
  'systems-design': 'Systems Design',
  performance: 'Performance',
  'cost-optimization': 'Cost Optimization',
  reliability: 'Reliability',
  'ml-infrastructure': 'ML Infrastructure',
  'data-engineering': 'Data Engineering',
  'technical-leadership': 'Technical Leadership',
  'developer-experience': 'Developer Experience',
};

// Generate breadcrumb schema for SEO
const breadcrumbSchema = generateBreadcrumbSchema(
  [
    { name: 'Home', url: import.meta.env.BASE_URL },
    { name: 'Case Studies', url: `${import.meta.env.BASE_URL}case-studies/` },
    {
      name: title,
      url: `${import.meta.env.BASE_URL}case-studies/${study.id}/`,
    },
  ],
  Astro.site?.toString() || ''
);

const footerLinks = [
  {
    url: `${import.meta.env.BASE_URL}case-studies/`,
    text: 'Back to Case Studies',
    direction: 'left' as const,
  },
  {
    url: `${import.meta.env.BASE_URL}resume/`,
    text: 'View Resume',
    direction: 'right' as const,
  },
];
---

<ArticleLayout
  title={title}
  description={description}
  backUrl={`${import.meta.env.BASE_URL}case-studies/`}
  backText="All Case Studies"
  ctaText="Want to discuss this project or similar work?"
  footerLinks={footerLinks}
  breadcrumbSchema={breadcrumbSchema}
  headerClass="study-header"
  contentClass="study-content"
  contentId="study-content"
  ogType="website"
>
  <!-- TL;DR Summary Box -->
  <Fragment slot="header-extra">
    {/* Key Metrics - inline badges */}
    {
      metrics && (metrics.primary || metrics.secondary) && (
        <div class="metrics-badges">
          {metrics.primary && (
            <span class="metric-badge">{metrics.primary}</span>
          )}
          {metrics.secondary && (
            <span class="metric-badge">{metrics.secondary}</span>
          )}
        </div>
      )
    }

    <div class="info-box">
      <div class="info-box-label">TL;DR</div>
      <p class="info-box-description">{description}</p>
      {
        outcome && (
          <div class="info-box-highlight">
            <strong>Result:</strong> {outcome}
          </div>
        )
      }
      <div class="info-box-meta">
        {
          role && (
            <span>
              <strong>Role:</strong> {role}
            </span>
          )
        }
        {
          duration && (
            <span>
              <strong>Timeline:</strong> {duration}
            </span>
          )
        }
      </div>
      {
        ownership && (
          <div class="info-box-footer">
            <strong>What I did:</strong> {ownership}
          </div>
        )
      }
    </div>

    {
      skills && skills.length > 0 && (
        <div class="labeled-tags">
          <span class="labeled-tags-label">Skills demonstrated:</span>
          <div class="labeled-tags-list">
            {skills.map((skill: string) => (
              <span class="labeled-tag-accent">
                {skillLabels[skill] || skill}
              </span>
            ))}
          </div>
        </div>
      )
    }

    {
      tech && tech.length > 0 && (
        <div class="labeled-tags">
          <span class="labeled-tags-label">Technologies:</span>
          <div class="labeled-tags-list">
            {tech.map((t: string) => (
              <span class="labeled-tag-subtle">{t}</span>
            ))}
          </div>
        </div>
      )
    }
  </Fragment>

  <!-- Related Case Studies and Writing -->
  <Fragment slot="related">
    {
      relatedPosts && relatedPosts.length > 0 && (
        <section class="related-articles">
          <h2>Technical Deep-Dives</h2>
          <p class="related-intro">
            {relatedPosts.length} article{relatedPosts.length === 1 ? '' : 's'}{' '}
            covering the architecture and implementation of this system.
          </p>
          <div class="related-grid">
            {relatedPosts.map((post) => (
              <a
                href={`${import.meta.env.BASE_URL}writing/${post.id}/`}
                class="related-card"
              >
                <span class="related-title">{post.data.title}</span>
                <span class="related-description">{post.data.description}</span>
                <div class="related-meta-row">
                  <span class="related-date">
                    {post.data.pubDate.toLocaleDateString('en-US', {
                      month: 'short',
                      year: 'numeric',
                    })}
                  </span>
                  {post.data.tags && post.data.tags.length > 0 && (
                    <div class="related-tags">
                      {post.data.tags.slice(0, 3).map((t: string) => (
                        <span class="related-tag">{t}</span>
                      ))}
                    </div>
                  )}
                </div>
              </a>
            ))}
          </div>
        </section>
      )
    }
    {
      relatedStudies && relatedStudies.length > 0 && (
        <section class="related-articles">
          <h2>Related Case Studies</h2>
          <div class="related-grid">
            {relatedStudies.map((related) => (
              <a
                href={`${import.meta.env.BASE_URL}case-studies/${related.id}/`}
                class="related-card"
              >
                <span class="related-title">{related.data.title}</span>
                <span class="related-description">
                  {related.data.description}
                </span>
                {related.data.tech && related.data.tech.length > 0 && (
                  <div class="related-tags">
                    {related.data.tech.slice(0, 3).map((t: string) => (
                      <span class="related-tag">{t}</span>
                    ))}
                  </div>
                )}
              </a>
            ))}
          </div>
        </section>
      )
    }
  </Fragment>

  <!-- Main content -->
  <slot />
</ArticleLayout>

<style>
  /* ===== Metrics Badges ===== */
  .metrics-badges {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
  }

  .metric-badge {
    display: inline-block;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-muted);
    background: var(--color-overlay-black-30);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    padding: var(--spacing-xs) var(--spacing-md);
    letter-spacing: var(--letter-spacing-subtle);
  }
</style>
